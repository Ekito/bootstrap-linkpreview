/* =========================================================
 * bootstrap-linkpreview.js
 * http://www.github.com/ekito/bootstrap-linkpreview
 *
 * Use:
 * $("#link").linkpreview({
 *     url: "http://romainpiel.com",            //optional
 *     previewContainer: "#preview-container",  //optional
 *     refreshButton: "#refresh-button"         //optional
 * });
 *
 * =========================================================
 * Copyright 2013 ekito - http://ekito.fr
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * ========================================================= */(function(e){var t=function(t,n){this.$element=e(t);this.options=n;if(!this.$element)return;this.initPreviewContainer();this.initUrlValue();if(n&&n.refreshButton){this.$refreshButton=e(n.refreshButton);var r=this;this.$refreshButton.on("click",function(){r.emptyPreviewContainer();r.initUrlValue();r.getSource(r.url,r.renderPreview,r.renderError)})}this.init()};t.prototype={constructor:t,url:null,$element:null,$previewContainer:null,$refreshButton:null,init:function(){this.getSource(this.url,this.renderPreview,this.renderError)},initPreviewContainer:function(){this.options&&this.options.previewContainer?this.$previewContainer=e(this.options.previewContainer):this.$previewContainer=this.$element.parent();this.$previewContainer.addClass("link-preview well row-fluid")},initUrlValue:function(){this.options&&this.options.url?this.url=this.options.url:this.url=this.$element.attr("href")||this.$element.text()||this.$element.val()},emptyPreviewContainer:function(){this.$previewContainer.empty()},getSource:function(t,n,r){if(!this.validateUrl(this.url))return;e.ajax({url:t,type:"GET",context:this,success:n,error:r})},renderPreview:function(t){t=t.replace(/<\/?[A-Z]+[\w\W]*?>/g,function(e){return e.toLowerCase()});var n=document.implementation.createHTMLDocument("");n.body.innerHTML=t;var r=e(n),i=this.findTitleInDom(r),s=this.findDescriptionInDom(r),o=this.findImageInDom(r),u=e("<h4></h4>").text(i),a=e("<p></p>").text(s),f=e("<img></img>").attr("src",o),l=e("<div></div>").addClass("span4"),c=e("<div></div>").addClass("span8");l.append(f);c.append(u).append(a);this.$previewContainer.append(l).append(c)},renderError:function(t){var n=e("<div></div>").addClass("alert alert-error").text("We are sorry we couldn't load the preview. The URL is invalid.");this.$previewContainer.append(n)},findTitleInDom:function(e){return e.find("title").text()||e.find("meta[name=title]").attr("content")},findDescriptionInDom:function(e){return e.find("meta[name=description]").attr("content")},findImageInDom:function(e){var t=e.find("meta[itemprop=image]").attr("content")||e.find("link[rel=image_src]").attr("content")||e.find("meta[itemprop=image]").attr("content")||this.findFirstImageInBody(e.find("body"));if(t&&!this.validateUrl(t)){var n=document.createElement("a");n.href=this.url;t=n.protocol+"//"+n.hostname+t}return t},findFirstImageInBody:function(t){var n,r=t.find("img[src]"),i;r.each(function(){i=e(this);if(i.attr("height")&&i.attr("height")>40&&i.attr("width")&&i.attr("width")>40){n=this.src;return!1}});return n},validateUrl:function(e){return/^(https?|ftp):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i.test(e)}};e.fn.linkpreview=function(n){return this.each(function(){var r=e(this),i=r.data("linkpreview"),s=typeof n=="object"&&n;i||r.data("linkpreview",i=new t(this,e.extend({},e.fn.linkpreview.defaults,s)));typeof n=="string"&&i[n]()})};e.fn.linkpreview.defaults={};e.fn.linkpreview.Constructor=t})(window.jQuery);